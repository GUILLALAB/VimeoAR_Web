<!DOCTYPE html>
<html lang="en">

<head>
	<title>Live AR - Broadcast</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
		integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css" rel="stylesheet">
	<!-- jQuery and Bootstrap JS -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"></script>
	<!-- AFrame -->
	<script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
	<script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
	<script
		src="https://cdn.rawgit.com/tizzle/aframe-orbit-controls-component/master/dist/aframe-orbit-controls-component.min.js"></script>
	<!-- Agora.io -->
	<script src="/js/AgoraRTCSDK-3.0.2.js" type="text/javascript"></script>
	<script src="/js/agora-rtm-sdk-1.2.2.js" type="text/javascript"></script>

	<!-- Material Design Lite -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
	<script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

	<!-- App Styling -->
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
	<script
		type="text/javascript">!function (n, e) { var t, o, i, c = [], f = { passive: !0, capture: !0 }, r = new Date, a = "pointerup", u = "pointercancel"; function p(n, c) { t || (t = c, o = n, i = new Date, w(e), s()) } function s() { o >= 0 && o < i - r && (c.forEach(function (n) { n(o, t) }), c = []) } function l(t) { if (t.cancelable) { var o = (t.timeStamp > 1e12 ? new Date : performance.now()) - t.timeStamp; "pointerdown" == t.type ? function (t, o) { function i() { p(t, o), r() } function c() { r() } function r() { e(a, i, f), e(u, c, f) } n(a, i, f), n(u, c, f) }(o, t) : p(o, t) } } function w(n) { ["click", "mousedown", "keydown", "touchstart", "pointerdown"].forEach(function (e) { n(e, l, f) }) } w(n), self.perfMetrics = self.perfMetrics || {}, self.perfMetrics.onFirstInputDelay = function (n) { c.push(n), s() } }(addEventListener, removeEventListener);</script>
	<link rel="stylesheet" type="text/css" href="style.css" />

	<!-- TODO: Enable First Input Delay polyfill library. -->

	<style>
		body,
		h1,
		h2,
		h3,
		h4,
		h5,
		h6 {
			font-family: "Lato", sans-serif
		}

		.w3-bar,
		h1,
		button {
			font-family: "Montserrat", sans-serif
		}

		.fa-anchor,
		.fa-coffee {
			font-size: 200px
		}

		.button-9 {
			appearance: button;
			backface-visibility: hidden;
			background-color: #405cf5;
			border-radius: 6px;
			border-width: 0;
			box-shadow: rgba(50, 50, 93, .1) 0 0 0 1px inset, rgba(50, 50, 93, .1) 0 2px 5px 0, rgba(0, 0, 0, .07) 0 1px 1px 0;
			box-sizing: border-box;
			color: #fff;
			cursor: pointer;
			font-family: -apple-system, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Ubuntu, sans-serif;
			font-size: 100%;
			height: 33px;
			line-height: 1.15;
			margin: 12px 0 0;
			outline: none;
			overflow: hidden;
			padding: 0 25px;
			position: relative;
			text-align: left;
			text-transform: none;
			transform: translateZ(0);
			transition: all .2s, box-shadow .08s ease-in;
			user-select: none;
			-webkit-user-select: none;
			touch-action: manipulation;
		}

		.button-9:disabled {
			cursor: default;
		}

		.button-9:focus {
			box-shadow: rgba(50, 50, 93, .1) 0 0 0 1px inset, rgba(50, 50, 93, .2) 0 6px 15px 0, rgba(0, 0, 0, .1) 0 2px 2px 0, rgba(50, 151, 211, .3) 0 0 0 4px;
		}

		.col-md-1 {
			margin-left: 10px;
			margin-top: 10px;

		}

		.mdl-textfield__input {
			background: black;
		}

		.mdl-button--raised[disabled][disabled],
		.mdl-button--raised.mdl-button--disabled.mdl-button--disabled {
			color: white;
		}

		#canvas {
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			margin: auto;
		}

		/* Split the screen in half */
.split {
  height: 50%;
  width: 50%;
  position: fixed;
  z-index: 1;
  top: 0;
  overflow-x: hidden;
  padding-top: 20px;
}

/* Control the left side */
.left {
  left: 0;
  background-color: #111;
}

/* Control the right side */
.right {
  right: 0;
  background-color: red;
}

/* If you want the content centered horizontally and vertically */
.centered {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Style the image inside the centered container, if needed */
.centered img {
  width: 150px;
  border-radius: 50%;
}
	</style>
</head>

<body>

	<!-- Header -->
	<header class="w3-container w3-black w3-center" style="padding:90px 20px">
		<input type="text" placeholder="enter a group name" id="myInput">
		<button class="button-9" role="button" id="start">Join</button>
		</li>
		<lu>
			<div id="audio-controls" class="col-md-1 text-center btn-group">
				<button id="mic-btn" type="button" class="btn btn-block btn-dark btn-lg">
					<i id="mic-icon" class="fas fa-microphone"></i>
				</button>
				<button id="mic-dropdown" type="button"
					class="btn btn-lg btn-dark dropdown-toggle dropdown-toggle-split" data-toggle="dropdown"
					aria-haspopup="true" aria-expanded="false">
					<span class="sr-only">Toggle Dropdown</span>
				</button>
				<div id="mic-list" class="dropdown-menu dropdown-menu-right">
				</div>
			</div>
		</lu>
		<lu>
			<div id="video-controls" class="col-md-1 text-center btn-group">
				<button id="video-btn" type="button" class="btn btn-block btn-dark btn-lg">
					<i id="video-icon" class="fas fa-video"></i>
				</button>
				<button id="cam-dropdown" type="button"
					class="btn btn-lg btn-dark dropdown-toggle dropdown-toggle-split" data-toggle="dropdown"
					aria-haspopup="true" aria-expanded="false">
					<span class="sr-only">Toggle Dropdown</span>
				</button>
				<div id="camera-list" class="dropdown-menu dropdown-menu-right">
				</div>
			</div>
		</lu>
		<lu>
			<div class="col-md-1 text-center btn-group">
				<button id="exit-btn" type="button" class="btn btn-block btn-danger btn-lg">
					<i id="exit-icon" class="fas fa-phone-slash"></i>
				</button>

			</div>
		</lu>

	</header>

	<!-- Navbar -->
	<div class="w3-top">
		<div class="w3-bar w3-black w3-card w3-left-align w3-large">
			<a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-black"
				href="javascript:void(0);" onclick="myFunction()" title="Toggle Navigation Menu"><i
					class="fa fa-bars"></i></a>
			<div id="user-container">
				<div hidden id="user-pic"></div>
				<div hidden id="user-name"></div>
				<button hidden id="sign-out"
					class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-color-text--white">
					Sign-out
				</button>
				<button hidden id="sign-in" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-color-text--white">
					<i class="material-icons">account_circle</i>Sign-in with Google
				</button>
			</div>
			<a href="#" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white"></a>
		</div>

		<!-- Navbar on small screens -->
		<div id="navDemo" class="w3-bar-block w3-white w3-hide w3-hide-large w3-hide-medium w3-large">
			<a href="#" class="w3-bar-item w3-button w3-padding-large"></a>
		</div>

	</div>


	<div class="split left">
		<div class="centered">
		  <img src="img_avatar2.png" alt="Avatar woman">
		  <div id="full-screen-video">
			<canvas id="canvas" width="532" height="300">
	
		</div>
	
		<video id="video" loop crossOrigin="anonymous" webkit-playsinline style="display:none">
		</video>
	
		<div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">
			<div id="messages-card-container" class="mdl-cell mdl-cell--12-col mdl-grid">
	
				<!-- Messages container -->
				<div id="messages-card"
					class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--6-col-tablet mdl-cell--6-col-desktop">
					<div class="mdl-card__supporting-text mdl-color-text--grey-600">
						<div id="messages">
						</div>
						<form id="message-form" action="#">
							<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
								<input class="mdl-textfield__input" type="text" id="message" autocomplete="off">
								<label class="mdl-textfield__label" for="message">Message...</label>
							</div>
							<button id="update" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">
								Update
							</button>
							<button id="submit" disabled type="submit"
								class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">
								Send
							</button>
						</form>
						<form id="image-form" action="#">
							<input id="mediaCapture" type="file" accept="image/*, .glb">
							<button id="submitImage" title="Add an image"
								class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-color--amber-400 mdl-color-text--white">
								<i class="material-icons">image</i>
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	
	
	
	
		</div>
		</div>
	  </div>
	  
	  <div class="split right">
		<div class="centered">
			<canvas id="c"></canvas>

		</div>
	  </div>

	<!--<div id="content">
	</div>-->

	<script src="utils.js"></script>


	<script id="vertexShader" type="glsl">

varying vec2 vUv;
void main( void ) {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
}

</script>


	<script id="fragmentShader" type="glsl">

uniform vec3 keyColor;
uniform float similarity;
uniform float smoothness;
varying vec2 vUv;
uniform sampler2D map;
void main() {

  vec4 videoColor = texture2D(map, vUv);

  float Y1 = 0.299 * keyColor.r + 0.587 * keyColor.g + 0.114 * keyColor.b;
  float Cr1 = keyColor.r - Y1;
  float Cb1 = keyColor.b - Y1;

  float Y2 = 0.299 * videoColor.r + 0.587 * videoColor.g + 0.114 * videoColor.b;
  float Cr2 = videoColor.r - Y2;
  float Cb2 = videoColor.b - Y2;

  float blend = smoothstep(similarity, similarity + smoothness, distance(vec2(Cr2, Cb2), vec2(Cr1, Cb1)));
  gl_FragColor = vec4(videoColor.rgb, videoColor.a * blend);
}

</script>

<script type="application/x-glsl" id="sky-vertex">  
	varying vec2 vUV;
	
	void main() {  
	  vUV = uv;
	  vec4 pos = vec4(position, 1.0);
	  gl_Position = projectionMatrix * modelViewMatrix * pos;
	}
	</script>
	
	<script type="application/x-glsl" id="sky-fragment">  
	uniform sampler2D texture;  
	varying vec2 vUV;
	
	void main() {  
	  vec4 sample = texture2D(texture, vUV);
	  gl_FragColor = vec4(sample.xyz, sample.w);
	}
	</script>  
	<script>
		$("#mic-btn").prop("disabled", true);
		$("#video-btn").prop("disabled", true);
		$("#exit-btn").prop("disabled", true);
	</script>
	<script type="module" src="/js/index.js"></script>
	<script src="/js/webvr-broadcast-client3D.js" type="module"></script>
	<script type="module">
		import * as THREE from './jsm/three.module.js';
		import { OrbitControls } from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/controls/OrbitControls.js';
		import { GLTFLoader } from './jsm/GLTFLoader.js';
		import {loadObject,Broadcaster} from './js/index.js';

		let controls, clickMouse, renderer,
			moveMouse, canvas,
			raycaster,
			draggableObject;
		var descriptionElement;
		var importedObject = null;
		var importedObjectposition;
		var video = null;
		var texture;
		document.addEventListener("stream", function (e) {
			// alert(e.detail);
			var link = e.detail;
			if (link != null) {
				addVideo(link);
				loadObject(link.idbroadcast);
			}
		});
		document.addEventListener("broadcastmodel", function(e) {
 // alert(e.detail);
 Broadcaster.objecturl=e.detail;
if (Broadcaster.objecturl!=null){
	setAds3DModel(Broadcaster.all);
}
});
	
		canvas = document.getElementById("c");

		const scene = new THREE.Scene();
		// const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
		var camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 1000);


		camera.position.z = 100;

		//   const renderer = new THREE.WebGLRenderer();
		//  renderer.setSize(window.innerWidth, window.innerHeight);
		renderer = new THREE.WebGLRenderer({ canvas: canvas });
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.shadowMap.enabled = true;
		// document.body.appendChild(renderer.domElement);
		//
		var update = document.getElementById('update');

		update.addEventListener("click", function (e) {
			if (importedObject != null) {
				//   importedObject.rotation.y += 0.01;
			//	UpdateAdsObject(Ads.link.IdRef, importedObjectposition.position.x, importedObjectposition.position.y, importedObjectposition.position.z);
			}
		});

		const planeGeometry = new THREE.PlaneBufferGeometry(50, 40, 8, 8);
		const planeMaterial = new THREE.MeshPhongMaterial({ color: 0xcccccc });
		const plane = new THREE.Mesh(planeGeometry, planeMaterial);
		plane.rotateX(-Math.PI / 2);
		plane.position.y = -3;
		plane.receiveShadow = true;
		plane.isDraggable = false;
		scene.add(plane);

		/*const content = document.getElementById('content');
		descriptionElement = document.createElement('div');
		descriptionElement.innerText = "test";
		content.appendChild(descriptionElement);*/

		/*const geometry = new THREE.BoxGeometry(2, 2, 2);
		const material = new THREE.MeshPhongMaterial({ color: 0xff00ff });
		const cube = new THREE.Mesh(geometry, material);
		cube.castShadow = true; //default is false
		cube.isDraggable = true;
		cube.name = "cube";
		scene.add(cube);*/



		/* const geo =  new THREE.SphereGeometry( 0.5, 12, 8 );
		 const mat = new THREE.MeshPhongMaterial({ color: 0xff00ff });
		 const sphere = new THREE.Mesh(geo, mat);
		 sphere.castShadow = true; //default is false
		 sphere.isDraggable = true;
		 sphere.name = "sphere";
		 scene.add(sphere);*/

		// CAMERA MOVEMENT CONTROLS
		controls = new OrbitControls(camera, renderer.domElement);
		controls.enableDamping = true;
		controls.update();

		raycaster = new THREE.Raycaster();
		clickMouse = new THREE.Vector2();
		moveMouse = new THREE.Vector2();

		const dirLight1 = new THREE.DirectionalLight(0xffffff);
		dirLight1.position.set(0, 2, 0);
		dirLight1.castShadow = true;
		scene.add(dirLight1);


		const ambientLight = new THREE.AmbientLight(0x444444);
		scene.add(ambientLight);

		const animate = function () {
			controls.update();

			// cube.rotation.x += 0.01;
			// cube.rotation.y += 0.007;

			if (importedObject != null) {
				var position = new THREE.Vector3();
				position.setFromMatrixPosition(importedObject.matrixWorld);
				// descriptionElement.innerText= position.x + ',' + position.y + ',' + position.z;
				//  descriptionElement.innerText= importedObject.position.x + ',' + importedObject.position.y + ',' + importedObject.position.z;
			}
			if (video != null) {
				if (video.readyState === video.HAVE_ENOUGH_DATA) {
					if (texture)
						texture.needsUpdate = true;
				}
			}
			// var position = new THREE.Vector3();
			// position.setFromMatrixPosition(cube.matrixWorld);
			//  descriptionElement.innerText= position.x + ',' + position.y + ',' + position.z;
			renderer.render(scene, camera);
			requestAnimationFrame(animate);

		};

		//loadLastAds();

		animate();


		function addVideo(id) {
			video = document.getElementById(id.videoid);
			texture = new THREE.VideoTexture(video);
			texture.minFilter = THREE.LinearFilter;
			texture.magFilter = THREE.LinearFilter;
			texture.format = THREE.RGBFormat;
			texture.flipY = true;

			var geom = new THREE.PlaneBufferGeometry(20, 10);

			const vertexShader = document.getElementById("vertexShader").textContent;
			const fragmentShader = document.getElementById("fragmentShader").textContent;

			var mater = new THREE.ShaderMaterial({
				transparent: true,
				uniforms: {
					map: { value: texture },
					keyColor: { value: [0.0, 1.0, 0.0] },
					similarity: { value: 0.74 },
					smoothness: { value: 0.0 }
				},
				vertexShader: vertexShader,
				fragmentShader: fragmentShader
			});
			mater.color = new THREE.Color();
			mater.metalness = 0;
			var mesh = new THREE.Mesh(geom, mater);
			mesh.castShadow = true; //default is false
			scene.add(mesh);
			mesh.position.set(0.0, 2, 0.0);

			video.onloadedmetadata = () => {
				video.play();

			}
		}

		function setAds3DModel(link) {
			const loader = new GLTFLoader();
			const self = this;
			// Load a glTF resource
			loader.load(
				// resource URL
				link.imageUrl + '&' + new Date().getTime(),
				// called when the resource is loaded
				function (gltf) {
					importedObject = gltf.scene;
					importedObject.scale.set(1.0, 1.0, 1.0);
					importedObject.position.set(link.position.x, link.position.y, link.position.z);
					importedObject.name = link.IdRef;
					importedObject.traverse(function (node) {

						if (node.isMesh) {
							node.castShadow = true;
							node.name = link.IdRef;
							node.isDraggable = true;
						}

					});

					scene.add(importedObject);
					scene.updateMatrix();
					scene.updateMatrixWorld(true);


				},
				// clled while loading is progressing
				function (xhr) {


				},
				// called when loading has errors
				function (error) {

					console.log(error);


				}
			);




		}

		function dragObject() {
			// If 'holding' an object, move the object
			if (draggableObject) {
				raycaster.setFromCamera(moveMouse, camera);
				// `found` is the metadata of the objects, not the objetcs themsevles
				const found = raycaster.intersectObjects(scene.children);
				if (found.length) {
					for (let obj3d of found) {
						if (!obj3d.object.isDraggablee) {
							draggableObject.position.x = obj3d.point.x;
							draggableObject.position.z = obj3d.point.z;
							importedObjectposition.position.x = obj3d.point.x;
							importedObjectposition.position.y = 0.0;
							importedObjectposition.position.z = obj3d.point.z;

							break;
						}
					}
				}
			}
		}

		window.addEventListener("click", (event) => {
			// If 'holding' object on-click, set container to <undefined> to 'drop' the object.
			if (draggableObject) {
				draggableObject = undefined;
				return;
			}

			// If NOT 'holding' object on-click, set container to <object> to 'pickup' the object.
			clickMouse.x = (event.clientX / window.innerWidth) * 2 - 1;
			clickMouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
			raycaster.setFromCamera(clickMouse, camera);
			const found = raycaster.intersectObjects(scene.children, true);
			if (found.length && found[0].object.isDraggable) {
				draggableObject = found[0].object;
				importedObjectposition = found[0].object;
			}
		});

		// Constantly updates the mouse location for use in `dragObject()`
		window.addEventListener("mousemove", (event) => {
			dragObject(); // Updates the object's postion every time the mouse moves
			moveMouse.x = (event.clientX / window.innerWidth) * 2 - 1;
			moveMouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
		});
	</script>
</body>

</html>