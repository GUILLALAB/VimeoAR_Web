<!doctype HTML>
<html>

<head>
  <title>MTB Bike Design</title>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <style>
    body,
    h1 {
      font-family: "Raleway", sans-serif
    }

    body,
    html {
      height: 100%
    }

    .bgimg {
      background-image: url('113097.jpg');
      min-height: 100%;
      background-position: center;
      background-size: cover;
    }

    p {
      margin: 2px;
      color: white;
    }

    .row {
      display: flex;
    }

    .mirror {
      transform: scaleX(-1);
    }

    input {
      margin-top: 20px;
    }

    #infinite-list {
      /* We need to limit the height and show a scrollbar */
      width: 200px;
      height: 300px;
      overflow: auto;

      /* Optional, only to check that it works with margin/padding */
      margin: 30px;
      padding: 20px;
      border: 5px solid rgb(255, 255, 255);
    }

    /* Optional eye candy below: */
    li {
      padding: 5px;
      list-style-type: none;
    }

    li:hover {
      background: rgb(255, 255, 255);
    }
    .row {
    display: block;
    overflow: auto;
    overflow-y: hidden;
    max-width: 100%;
    margin: 0 0 1em;
    white-space: nowrap;
}

.row li {
    display: block;
    vertical-align: top;
    position: absolute;
    z-index: 10
}
    .notification {
      background-color: #555;
      color: white;
      text-decoration: none;
      padding: 15px 15px;
      position: absolute;
      bottom: 0;
      margin-bottom: 150px;
      display: inline-block;
      border-radius: 2px;
    }

    .notification:hover {
      background: red;
    }

    .notification .badge {
      position: absolute;
      top: -10px;
      right: -10px;
      padding: 5px 10px;
      border-radius: 50%;
      background: red;
      color: white;
    }

    #myProgress {  width: 100%;  background-color: grey;} 
#myBar {  width: 1%;  height: 30px;  background-color: green;}
.container {
  background-color:#2e427200;
  display:flex;
  padding-bottom: 100px;
}
  </style>
</head>

<link href="https://fonts.googleapis.com/css?family=Heebo:400,700|Oxygen:700" rel="stylesheet">
<script src="https://unpkg.com/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
<link rel="stylesheet" type="text/css" href="style_bike.css" />
<link rel="stylesheet" type="text/css" href="/js/color-picker.css" media="all">
<script type="text/javascript" src="/js/color-picker.js"></script>
<!-- Material Design Lite -->
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
<script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

<!-- App Styling -->
<link rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">

  	  <!-- TODO: AWS Login. -->

      <link rel="preconnect" href="https://fonts.gstatic.com">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
      <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
      <script src="/js/jquery.min.js"></script>	
      <script src="/js/aws-sdk-2.487.0.min.js"></script>
      <script src="/js/aws-cognito-sdk.min.js"></script>
      <script src="/js/amazon-cognito-identity.min.js"></script>
      <script src="https://sdk.amazonaws.com/js/aws-sdk-2.410.0.min.js"></script>
      <script src="/js/awsuploadvideotest.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>

      
<body style="background-color:black;text-align:center">
  <!-- Navbar -->

  <div class="w3-top">
    <div class="w3-bar w3-black w3-card w3-left-align w3-large">
      <div id="user-container">

        <div hidden id="user-pic"></div>
        <div hidden id="user-name"></div>
        <button id="logout" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-color-text--white" >Log Out</button>

        <button hidden id="sign-out" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-color-text--white">
          Sign-out
        </button>
        <button hidden id="sign-in" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-color-text--white">
          <i class="material-icons"></i>Sign-in
        </button>
      </div>
      
      <a href="#" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white"></a>
    </div>

  </div>

  
  <div class="row">
    <ul id="home_product"></ul>
</div>


  <div id="messages-card-container" class="mdl-cell mdl-cell--12-col mdl-grid">
    <div class="row">


      <div id="background-container">
        <ul>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
        </ul>
      </div>
      <div id="caption-container">
        <div id="butterfly"><div class="wings"></div></div>
      
      </div>
    	<div class="flip-container">
        <div class="flipper">
          <div class="front color-picker-dark-theme"></div>
          <div class="back color-picker-light-theme"></div>
        </div>
      </div>
       </div>

    <!-- Messages container -->
    <div id="messages-card"
      class="mdl-card mdl-shadow--0dp mdl-cell mdl-cell--12-col mdl-cell--6-col-tablet mdl-cell--6-col-desktop">
      <div id="messages">
      </div>

    </div>
   
  </div>


  <canvas id="c"></canvas>

  <div class="container py5">
  


</div>


  <script src="utils.js"></script>
   
    <script>

      //=============== AWS IDs ===============
      var userPoolId = 'eu-west-1_3x9L2hsjh';
      var clientId = '4gkuhfpqeo9rc279nh727l3sco';
      var region = 'eu-west-1';
      var identityPoolId = 'eu-west-1:a40474e9-d90b-494d-836d-7e55d8f9da3b';
      //=============== AWS IDs ===============
    
      var cognitoUser;
      var idToken;
      var userPool;
      
      var poolData = { 
        UserPoolId : userPoolId,
        ClientId : clientId
      };
      getCurrentLoggedInSession();
      
    document.getElementById("logout").addEventListener("click", function (e) {
      if( $("#logout").text()==="SIGN IN"){
        window.location = "https://livear.herokuapp.com/login";
      }else{
        logOut();
      }
    });
   
    
      function getCurrentLoggedInSession(){
    
    userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
    cognitoUser = userPool.getCurrentUser();
    
    if(cognitoUser != null){
      cognitoUser.getSession(function(err, session) {
        if (err) {
          console.log(err.message);
        }else{
          console.log('Session found! Logged in.');
          idToken = session.getIdToken().getJwtToken();
          localStorage.setItem("sub", session.getIdToken().decodePayload().sub);
          $("#logout").show();
    
          getCognitoIdentityCredentials();
        }
      });
    }else{
      $("#logout").show();
      $("#logout").html("SIGN IN");

      console.log('Logout');
     // window.location = "https://livear.herokuapp.com/login";
    
    }
    
    }
    function logOut(){
          if (cognitoUser != null) {
            cognitoUser.signOut();
            $("#logout").html("SIGN IN");
            console.log('Logged out!');
          //  window.location = "https://livear.herokuapp.com/login";
          }
        }
    
        function getCognitoIdCredentials(){
          AWS.config.region = region;
    
          var loginMap = {};
          loginMap['cognito-idp.' + region + '.amazonaws.com/' + userPoolId] = idToken;
    
          AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: identityPoolId,
            Logins: loginMap
          });
    
          AWS.config.credentials.clearCachedId();
    
        return AWS.config.credentials;
        }
        
    function getCognitoIdentityCredentials(){
          AWS.config.region = region;
    
          var loginMap = {};
          loginMap['cognito-idp.' + region + '.amazonaws.com/' + userPoolId] = idToken;
    
          AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: identityPoolId,
            Logins: loginMap
          });
    
          AWS.config.credentials.clearCachedId();
    
          AWS.config.credentials.get(function(err) {
            if (err){
              console.log(err.message);
            }
            else {
              console.log('AWS Access Key: '+ AWS.config.credentials.accessKeyId);
              console.log('AWS Secret Key: '+ AWS.config.credentials.secretAccessKey);
              console.log('AWS Session Token: '+ AWS.config.credentials.sessionToken);
            }
    
          });
        }
    </script>

  <script type="module">
    import * as THREE from './jsm/three.module.js';
    import { OrbitControls } from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from './jsm/GLTFLoader.js';

    import { LoadingBar } from './jsm/LoadingBar.js';

    let container;
    let camera, scene, renderer, source;
    let controller;
    var importedObject = null;
    var video = null;
    let controls, canvas;
    var cube, texture, material;
    var client = null;
    var ads = null;
    var mesh = null;
    var tex = null;
    var offscreenCanvas;
    var offscreenCanvas;
    let height, width;
    var object_badge = 0;
    // canvas green screen controls
    var assetsPath;
    // Safari & Firefox don't support OffscreenCanvas
    var instance=null;
    var loadingBar;
    var clock;
    var objects = 0;
    var mixer=null;
    var plane=null;
    var chair=null;
    var colorinstance={};

    var angle = 0; // текущий угол
var angularSpeed = THREE.Math.degToRad(20); // угловая скорость - градусов в секунду
var delta = 0;
var radius = 190;
    var seatstays;
    var headtube;
    var frame;
    var chainstays;
    var airshock;
    var Pivot;
    var logo;
    var tires;
    var Suspension;
    var hubs;
    var fork;


    function removeEntity(object) {
    var selectedObject = scene.getObjectByName(object.name);
    scene.remove( selectedObject );
    animate();
}
   

    document.addEventListener("buttonclick", function (e) {
var data = e.detail;
if (data != null) {
  console.log(data);


if (chair!=null) {
chair.traverse((node) => {

if (node.isMesh) {
node.castShadow = true;
console.log(node.name);
//  node.name = link.IdRef;
node.isDraggable = true;
}
// search the mesh's children for the face-geo
if (node.isMesh && node.name == data.parts) {
  var instances = GetInstance(data);

instances.on('change', (colorvalue) => {

node.material.color.set(colorvalue.toHEX());
});
}
});
}
//dark_color_picker.color.fromHSVa(color.h, color.s, color.v, color.a);

}


});

    initAWS();
    init();

    function initAWS(){
     
      var userPoolId = 'eu-west-1_3x9L2hsjh';
      var region = 'eu-west-1';
      var identityPoolId = 'eu-west-1:a40474e9-d90b-494d-836d-7e55d8f9da3b';
      //=============== AWS IDs ===============
          var idToken;
      

AWS.config.region = region;
      
    getCognitoIdCredentials().get(function(err) {
  if (err) console.log(err.stack);
  
  // credentials not loaded
  else {
    console.log("Access key:", AWS.config.credentials.accessKeyId);
    const itemsAll = scanAll("MTB");
    itemsAll.then(function(value) {
      for(var i =0;i<11;i++){
        if(value[i]!== undefined){
     // console.log(value[i]);
      loadProducts(value[i]);
setInstance(value[i]);
    }
      }
    // expected output: 123
});

  }
});

const documentClient = new AWS.DynamoDB.DocumentClient();

const scanAll = async (tableName) => {
  let lastEvaluatedKey = 'dummy'; // string must not be empty
  const itemsAll = [];
  let table = { TableName: tableName };


  while (lastEvaluatedKey) {
    const data = await documentClient.scan(table).promise();
    itemsAll.push(...data.Items);
    lastEvaluatedKey = data.LastEvaluatedKey;
    if (lastEvaluatedKey) {
      table.ExclusiveStartKey = lastEvaluatedKey;
      console.log(table.ExclusiveStartKey);
    }
  }
  return itemsAll;
}

    }
    
    function GetInstance(data){
      var instance=null;
      if(data.parts=="seatstays"){
        instance=seatstays;
      }
      else if(data.parts=="headtube"){
         instance=headtube;

      }else if(data.parts=="frame"){
        instance=frame;

      }else if(data.parts=="chainstays"){
         instance=chainstays;

      }else if(data.parts=="airshock"){
        instance=airshock;

      }else if(data.parts=="Pivot"){
         instance=Pivot;

      }else if(data.parts=="logo"){
         instance=logo;
      }
      else if(data.parts=="fork"){
         instance=fork;
      }
      else if(data.parts=="Suspension"){
         instance=Suspension;
      }else if(data.parts=="hubs"){
         instance=hubs;
      }else if(data.parts=="tires"){
         instance=tires;
      }
      return instance;
    }

    function setInstance(data){
      if(data.parts=="seatstays"){
        seatstays = new ColorPickerControl({ container: document.querySelector('.color-picker-light-theme'), theme: 'light' });
      }
      else if(data.parts=="headtube"){
         headtube = new ColorPickerControl({ container: document.querySelector('.color-picker-light-theme'), theme: 'light' });

      }else if(data.parts=="frame"){
        frame = new ColorPickerControl({ container: document.querySelector('.color-picker-light-theme'), theme: 'light' });

      }else if(data.parts=="chainstays"){
         chainstays = new ColorPickerControl({ container: document.querySelector('.color-picker-light-theme'), theme: 'light' });

      }else if(data.parts=="airshock"){
        airshock  = new ColorPickerControl({ container: document.querySelector('.color-picker-light-theme'), theme: 'light' });

      }else if(data.parts=="Pivot"){
         Pivot = new ColorPickerControl({ container: document.querySelector('.color-picker-light-theme'), theme: 'light' });

      }else if(data.parts=="logo"){
         logo = new ColorPickerControl({ container: document.querySelector('.color-picker-light-theme'), theme: 'light' });

      }
      else if(data.parts=="fork"){
        fork = new ColorPickerControl({ container: document.querySelector('.color-picker-light-theme'), theme: 'light' });
      }
      else if(data.parts=="Suspension"){
        Suspension = new ColorPickerControl({ container: document.querySelector('.color-picker-light-theme'), theme: 'light' });
      }else if(data.parts=="hubs"){
        hubs = new ColorPickerControl({ container: document.querySelector('.color-picker-light-theme'), theme: 'light' });
      }else if(data.parts=="tires"){
        tires = new ColorPickerControl({ container: document.querySelector('.color-picker-light-theme'), theme: 'light' });
      }
    }

    function addImage(data){
var image;
      if(data.parts=="seatstays"){
        image = "/images/seatstay.png";
      }
      else if(data.parts=="headtube"){
        image = "/images/headtube.png";

      }else if(data.parts=="frame"){
        image = "/images/frame.png";

      }else if(data.parts=="chainstays"){
        image = "/images/chainstay.png";

      }else if(data.parts=="airshock"){
        image = "/images/airshock.png";

      }else if(data.parts=="Pivot"){
        image = "/images/pivot.png";

      }else if(data.parts=="logo"){
        image = "/images/logo.png";

      }else if(data.parts=="fork"){
        image = "/images/fork.png";

      }else if(data.parts=="Suspension"){
        image = "/images/Suspension.png";

      }else if(data.parts=="tires"){
        image = "/images/tires.png";

      }else if(data.parts=="hubs"){
        image = "/images/hubs.png";

      }
return image;
    }
    function loadProducts(data){

var li = document.createElement('li');

var Template = '<div  class="card mt-1">'+
'<div id="btn" class="product-1 align-items-center p-2 text-center"> <img src="'+addImage(data)+'" class="rounded" width="150" height="100">'+
    '<div class="message"> <span class="text1 d-block">'+ data.parts+' </span> </div>'+
'</div>'+
'</div>';

li.innerHTML = Template;

li.setAttribute('id', data.id);

li.querySelector("#btn").myParam = data;

li.querySelector("#btn").addEventListener('click', myFunc, false);


document.getElementById("home_product").appendChild(li);
    }

     function myFunc(evt) {
  var test = evt.currentTarget.myParam;
var event = new CustomEvent("buttonclick", { "detail": test });
  document.dispatchEvent(event);
}





    function init() {

      assetsPath = './ar-shop/';
      loadingBar = new LoadingBar();
      loadingBar.visible = false;

 


      canvas = document.getElementById("c");

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 70;

      renderer = new THREE.WebGLRenderer({ canvas: canvas });
     // renderer.setSize(window.innerWidth, window.innerHeight);
     onWindowResize();
      renderer.shadowMap.enabled = true;

  

      const planeGeometry = new THREE.PlaneBufferGeometry(40, 40, 8, 8);
    //  const planeMaterial = new THREE.MeshPhongMaterial({ color: 0x222222 });
      const   planeMaterial = new THREE.MeshBasicMaterial({
        color: 0x222222,
        wireframe: true
    });
  //    planeMaterial.transparent = true;
// set opacity to 50%
//planeMaterial.opacity = 0.8; 
       plane = new THREE.Mesh(planeGeometry, planeMaterial);
      plane.rotateX(-Math.PI / 2);
      plane.position.y = -3;
      plane.receiveShadow = true;
      plane.isDraggable = false;
      scene.add(plane);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.update();


      const dirLight1 = new THREE.DirectionalLight(0xffffff);
      dirLight1.position.set(0, 50, 0);
      dirLight1.castShadow = true;
      scene.add(dirLight1);

      const dirLight2 = new THREE.DirectionalLight(0xffffff);

      dirLight2.position.set(0, -50, 0);
      dirLight2.castShadow = true;
      scene.add(dirLight2);


      const dirLight3 = new THREE.DirectionalLight(0xffffff);

dirLight3.position.set(0, 0, -50.0);
dirLight3.castShadow = true;
scene.add(dirLight3);

const dirLight4 = new THREE.DirectionalLight(0xffffff);

dirLight4.position.set(0, 0, +50.0);
dirLight4.castShadow = true;
scene.add(dirLight4);

      clock = new THREE.Clock();

setAds3DModel("https://videoaws-source-8r4bwmp9uami.s3.eu-west-1.amazonaws.com/video/5789c62c-4c34-459c-8f3a-a5b744266fc2/7a6341ab-997e-4dd3-8a0a-1fa7f28a3886/objects/bikeframe3.glb");
      //createBroadcaster();
      //

      //
      const animate = function () {
        camera.translate.x+= 0.01;

        // cube.rotation.x += 0.01;
        // cube.rotation.y += 0.007;
      /*  if(plane!=null){
          var delta = clock.getDelta();
          camera.position.x = Math.cos(angle) * radius;
          angle += angularSpeed * delta; // приращение угла
          camera.lookAt(plane.position);
        }*/
       

        // var position = new THREE.Vector3();
        // position.setFromMatrixPosition(cube.matrixWorld);
        //  descriptionElement.innerText= position.x + ',' + position.y + ',' + position.z;
        renderer.render(scene, camera);
        requestAnimationFrame(animate);

      };
      animate();
    }
  

// usage:
    function setAds3DModel(link) {
      loadingBar.visible = true;

      const loader = new GLTFLoader();
      const self = this;
      // Load a glTF resource
      loader.load(
        // resource URL
        link,
        // called when the resource is loaded
        function (gltf) {

          gltf.scene.name=link;
          scene.add(gltf.scene);

          chair = gltf.scene;
          chair.name = link;

          chair.traverse((node) => {

            if (node.isMesh) {
              node.castShadow = true;
            //  node.name = link.IdRef;
              node.isDraggable = true;
            }
            // search the mesh's children for the face-geo
            if (node.isMesh && node.name == 'face-geo'|| node.name == 'body-geo') {
              // create video texture from video element
              var texture = new THREE.TextureLoader().load("112097.jpg");
              texture.minFilter = THREE.LinearFilter;
              texture.magFilter = THREE.LinearFilter;
              texture.flipY = false;
              node.material.map = texture;
              node.material.color = new THREE.Color();
              node.material.metalness = 0;
            }
          });


          chair.visible = false;
          loadingBar.visible = false;
          chair.position.set(0.0, 2.0, objects + 0.0);
        //  chair.scale.set(4.0, 4.0, 4.0);

          scene.updateMatrix();
          scene.updateMatrixWorld(true);

          objects = objects + 4;

          chair.visible = true;
        },
        // called while loading is progressing
        function (xhr) {

          loadingBar.progress = (xhr.loaded / xhr.total);

        },
        // called when loading has errors
        function (error) {

          console.log(error);
          loadingBar.visible = false;


        }
      );




    }

    function onWindowResize() {

      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();

      renderer.setSize(window.innerWidth-200, window.innerHeight-200);

    }

  </script>
  <script src="/js/main.min.js"></script>

  
</body>


</html>