<!doctype HTML>
<html>

<head>
  <title>Live AR - Visualize</title>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <style>
    body,
    h1 {
      font-family: "Raleway", sans-serif
    }

    body,
    html {
      height: 100%
    }

    .bgimg {
      background-image: url('113097.jpg');
      min-height: 100%;
      background-position: center;
      background-size: cover;
    }

    p {
      margin: 2px;
      color: white;
    }

    .row {
      display: flex;
    }

    .mirror {
      transform: scaleX(-1);
    }

    input {
      margin-top: 20px;
    }

    #infinite-list {
      /* We need to limit the height and show a scrollbar */
      width: 200px;
      height: 300px;
      overflow: auto;

      /* Optional, only to check that it works with margin/padding */
      margin: 30px;
      padding: 20px;
      border: 5px solid rgb(255, 255, 255);
    }

    /* Optional eye candy below: */
    li {
      padding: 5px;
      list-style-type: none;
      background: white;
    }

    li:hover {
      background: rgb(255, 255, 255);
    }

    .notification {
      background-color: #555;
      color: white;
      text-decoration: none;
      padding: 15px 15px;
      position: absolute;
      bottom: 0;
      margin-bottom: 150px;
      display: inline-block;
      border-radius: 2px;
    }

    .notification:hover {
      background: red;
    }

    .notification .badge {
      position: absolute;
      top: -10px;
      right: -10px;
      padding: 5px 10px;
      border-radius: 50%;
      background: red;
      color: white;
    }
  </style>
</head>
<script src="/js/AgoraRTCSDK-3.0.2.js" type="text/javascript"></script>
<script src="/js/agora-rtm-sdk-1.2.2.js" type="text/javascript"></script>
<link href="https://fonts.googleapis.com/css?family=Heebo:400,700|Oxygen:700" rel="stylesheet">
<script src="https://unpkg.com/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
<link rel="stylesheet" type="text/css" href="style_listBroadcast.css" />

<!-- Material Design Lite -->
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
<script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

<!-- App Styling -->
<link rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">

<body style="background-color:black;text-align:center">
  <!-- Navbar -->

  <div class="w3-top">
    <div class="w3-bar w3-black w3-card w3-left-align w3-large">
      <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-black"
        href="javascript:void(0);" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
      <div id="user-container">
        <div hidden id="user-pic"></div>
        <div hidden id="user-name"></div>
        <button hidden id="sign-out" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-color-text--white">
          Sign-out
        </button>
        <button hidden id="sign-in" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-color-text--white">
          <i class="material-icons"></i>Sign-in
        </button>
      </div>
      <a href="#" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white"></a>
    </div>

    <!-- Navbar on small screens -->
    <div id="navDemo" class="w3-bar-block w3-white w3-hide w3-hide-large w3-hide-medium w3-large">
      <a href="#" class="w3-bar-item w3-button w3-padding-large"></a>
    </div>

  </div>



  <input type="text" placeholder="broadcaster channel name" id="myInput">


  <div id="messages-card-container" class="mdl-cell mdl-cell--12-col mdl-grid">

    <!-- Messages container -->
    <div id="messages-card"
      class="mdl-card mdl-shadow--0dp mdl-cell mdl-cell--12-col mdl-cell--6-col-tablet mdl-cell--6-col-desktop">
      <div id="messages">
      </div>


    </div>
    <a id="badgeButton" href="#" class="notification">
      <span>Objects</span>
      <span id="object_badge" class="badge"></span>
    </a>
  </div>


  <video id="video" loop crossOrigin="anonymous" webkit-playsinline style="display:none">
    <source id="source" src="video.mp4" type="video/mp4">
  </video>

  <canvas id="c"></canvas>


  <script src="utils.js"></script>


  <script id="vertexShader" type="glsl">

    varying vec2 vUv;
    void main( void ) {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
    }

    </script>


  <script id="fragmentShader" type="glsl">

    uniform vec3 keyColor;
    uniform float similarity;
    uniform float smoothness;
    varying vec2 vUv;
    uniform sampler2D map;
    void main() {

      vec4 videoColor = texture2D(map, vUv);

      float Y1 = 0.299 * keyColor.r + 0.587 * keyColor.g + 0.114 * keyColor.b;
      float Cr1 = keyColor.r - Y1;
      float Cb1 = keyColor.b - Y1;

      float Y2 = 0.299 * videoColor.r + 0.587 * videoColor.g + 0.114 * videoColor.b;
      float Cr2 = videoColor.r - Y2;
      float Cb2 = videoColor.b - Y2;

      float blend = smoothstep(similarity, similarity + smoothness, distance(vec2(Cr2, Cb2), vec2(Cr1, Cb1)));
      gl_FragColor = vec4(videoColor.rgb, videoColor.a * blend);
    }

    </script>


  <script type="module">
    import * as THREE from './jsm/three.module.js';
    import { OrbitControls } from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from './jsm/GLTFLoader.js';

    import { FBXLoader } from './jsm/FBXLoader.js';

    import { LoadingBar } from './jsm/LoadingBar.js';
    import { ARButton } from './jsm/webxr/ARButton.js';

    let container;
    let camera, scene, renderer, source;
    let controller;

    let clickMouse,
      moveMouse,
      raycaster,
      draggableObject;
    var importedObject = null;
    var importedObjectposition;
    var video = null;
    let reticle, controls, canvas;
    var cube, texture, material;
    var isset = 0;
    let videoTexture;
    let videoImageContext;
    let hitTestSource = null;
    let hitTestSourceRequested = false;
    var client = null;
    var ads = null;
    var mesh = null;
    var tex = null;
    var chair = null;
    var streamCount;
    var channelName;
    var agoraAppId;
    var rtmClient = null;
    var offscreenCanvas;
    var videoElement;
    var transparentCanvas;
    var callBtnTransparent;
    var videoEnabled;
    var transparencyEnabled;
    var offscreenCanvas;
    let height, width;
    let videoDevices = [];
    var object_badge = 0;
    var object_badges;
    var badgeButton;
    // canvas green screen controls
    const gFloorRange = 105;
    const rbCeilingRange = 80;
    const FRAME_RATE = 25;
    let videoWidth = 320;
    let videoHeight = 240;
    var assetsPath;
    // Safari & Firefox don't support OffscreenCanvas
    var mixer = null;

    var loadingBar;
    let segmentedCanvas;
    var clock;
    var objects = 0;

    init();

    function myFunction() {
      video.play();
    }


    function StopVideo() {
      document.getElementById('video').pause();
    }



    function init() {

      assetsPath = './ar-shop/';
      loadingBar = new LoadingBar();
      loadingBar.visible = false;

    
      canvas = document.getElementById("c");

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 100;

      renderer = new THREE.WebGLRenderer({ canvas: canvas });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;

      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      light.position.set(0.5, 1, 0.25);
      scene.add(light);


      const planeGeometry = new THREE.PlaneBufferGeometry(50, 40, 8, 8);
      const planeMaterial = new THREE.MeshPhongMaterial({ color: 0x222222 });
      const plane = new THREE.Mesh(planeGeometry, planeMaterial);
      plane.rotateX(-Math.PI / 2);
      plane.position.y = -3;
      plane.receiveShadow = true;
      plane.isDraggable = false;
      scene.add(plane);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.update();


      const dirLight1 = new THREE.DirectionalLight(0xffffff);
      dirLight1.position.set(0, 2, 0);
      dirLight1.castShadow = true;
      scene.add(dirLight1);


      const ambientLight = new THREE.AmbientLight(0x444444);
      scene.add(ambientLight);

      clock = new THREE.Clock();

      object_badges = document.getElementById('object_badge');
      object_badges.textContent = object_badge;
      badgeButton = document.getElementById('badgeButton');
      createBroadcaster();
      //


      //
      const animate = function () {

        // cube.rotation.x += 0.01;
        // cube.rotation.y += 0.007;


        if (video != null) {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            if (texture)
              texture.needsUpdate = true;
          }
        }


        // var position = new THREE.Vector3();
        // position.setFromMatrixPosition(cube.matrixWorld);
        //  descriptionElement.innerText= position.x + ',' + position.y + ',' + position.z;
        renderer.render(scene, camera);
        requestAnimationFrame(animate);

      };
      animate();
    }

    function onWindowResize() {

      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();

      renderer.setSize(window.innerWidth, window.innerHeight);

    }


   


 

   

    // Agora RTM
    // setu the RTM clit and channel


    function createBroadcaster() {
      // create video element
      video = document.getElementById('video');
      source = document.getElementById('source');

      video.setAttribute('webkit-playsinline', 'webkit-playsinline');
      video.setAttribute('playsinline', 'playsinline');
      video.setAttribute('poster', '/imgs/no-video.jpg');
      video.pause();
      video.setAttribute('crossorigin', 'anonymous');
      source.src = "https://videoaws-source-8r4bwmp9uami.s3.eu-west-1.amazonaws.com/bike4.mp4";
      video.load();
      texture = new THREE.VideoTexture(video);
      texture.minFilter = THREE.LinearFilter;
      texture.magFilter = THREE.LinearFilter;
      texture.format = THREE.RGBFormat;

      var geometry = new THREE.PlaneBufferGeometry(25, 12);

      const vertexShader = document.getElementById("vertexShader").textContent;
      const fragmentShader = document.getElementById("fragmentShader").textContent;

      material = new THREE.ShaderMaterial({
        transparent: true,
        uniforms: {
          map: { value: texture },
          keyColor: { value: [0.0, 1.0, 0.0] },
          similarity: { value: 0.74 },
          smoothness: { value: 0.0 }
        },
        vertexShader: vertexShader,
        fragmentShader: fragmentShader
      });
      material.color = new THREE.Color();
      material.metalness = 0;
      mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);
      mesh.position.set(0.0, 1.5, -7.0);

      video.play();
        isset = 1;
     
      //ads

    }

  


   
    //

 

    

   
  







  </script>
  <script type="module" src="/js/index_greenscreen.js"></script>
  <script src="/js/main.min.js"></script>
 
</body>

<!-- for broadcast user use: https://digitallysavvy.github.io/group-video-chat -->

</html>